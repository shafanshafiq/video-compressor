
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Robust Video Compressor</title>
  <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 700px;
      margin: auto;
      padding: 20px;
      text-align: center;
    }
    input, button, select {
      margin: 10px 0;
      padding: 10px;
    }
    #log {
      margin-top: 20px;
      font-size: 0.9em;
      color: green;
      white-space: pre-line;
    }
    video {
      width: 100%;
      max-height: 300px;
      margin-top: 10px;
    }
    #downloadLink {
      display: none;
      margin-top: 20px;
      padding: 10px 20px;
      background-color: #28a745;
      color: white;
      text-decoration: none;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <h2>üé¨ Robust Video Compressor (Client-side)</h2>
  <input type="file" id="uploader" accept="video/*"><br>
  <label for="quality">Select Compression Quality:</label>
  <select id="quality">
    <option value="35">Low</option>
    <option value="28" selected>Medium</option>
    <option value="23">High</option>
  </select><br>
  <button onclick="compressVideo()">Compress Video</button>
  <p id="log"></p>

  <h3>Original Video Preview</h3>
  <video id="originalVideo" controls></video>

  <h3>Compressed Video Preview</h3>
  <video id="compressedVideo" controls></video>

  <a id="downloadLink" download="compressed_video.mp4">‚¨á Download Compressed Video</a>

  <script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    const log = document.getElementById('log');
    const downloadLink = document.getElementById('downloadLink');
    const originalVideo = document.getElementById('originalVideo');
    const compressedVideo = document.getElementById('compressedVideo');

    const ffmpeg = createFFmpeg({
      log: true,
      progress: (p) => {
        log.textContent = `‚è≥ FFmpeg Loading: ${Math.round(p.ratio * 100)}%`;
      }
    });

    document.getElementById('uploader').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const url = URL.createObjectURL(file);
        originalVideo.src = url;
        log.textContent = "üéû Video loaded. Ready to compress.";
      }
    });

    async function compressVideo() {
      const fileInput = document.getElementById('uploader');
      const quality = document.getElementById('quality').value;
      const file = fileInput.files[0];
      if (!file) {
        alert("Please select a video file.");
        return;
      }

      log.textContent = "‚è≥ Loading FFmpeg...";

      try {
        if (!ffmpeg.isLoaded()) await ffmpeg.load();
        const inputName = 'input.mp4';
        const outputName = 'compressed_' + Date.now() + '.mp4';

        ffmpeg.FS('writeFile', inputName, await fetchFile(file));
        log.textContent = "üì¶ Compressing video...";

        await ffmpeg.run(
          '-i', inputName,
          '-preset', 'fast',
          '-vcodec', 'libx264',
          '-crf', quality,
          '-movflags', 'faststart',
          '-pix_fmt', 'yuv420p',
          outputName
        );

        const data = ffmpeg.FS('readFile', outputName);
        const videoBlob = new Blob([data.buffer], { type: 'video/mp4' });
        const videoUrl = URL.createObjectURL(videoBlob);

        downloadLink.href = videoUrl;
        downloadLink.style.display = 'inline-block';
        compressedVideo.src = videoUrl;
        log.textContent = "‚úÖ Compression complete!";
      } catch (err) {
        console.error("‚ùå Compression failed:", err);
        log.textContent = "‚ùå Compression failed. " + err.message + "\nTry a different browser or smaller video.";
      }
    }
  </script>
</body>
</html>
