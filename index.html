<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Universal Video Compressor</title>
  <style>
    /* …[same styling as before]… */
  </style>
</head>
<body>
  <div class="container">
    <h1>Universal Video Compressor</h1>

    <div class="file-input">
      <label>Select Video File:</label>
      <input type="file" id="videoFile" accept="video/*">
    </div>

    <div id="dropZone">Or drag and drop your video here</div>

    <div class="controls">
      <!-- [Quality, Preset, Resolution controls] -->
    </div>

    <button id="compressBtn" disabled>Compress Video</button>
    <div id="loadingSpinner"></div>

    <div id="progressContainer">
      <p>Compressing... <span id="progressText">0%</span></p>
      <progress id="progressBar" value="0" max="100"></progress>
    </div>

    <div id="outputContainer">
      <!-- [file info + preview + download link] -->
    </div>
  </div>

  <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.10/dist/umd/ffmpeg.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const videoFile = document.getElementById('videoFile');
      const compressBtn = document.getElementById('compressBtn');
      const dropZone = document.getElementById('dropZone');
      const spinner = document.getElementById('loadingSpinner');
      // ... [other UI elements like progressBar, selectors] ...
      
      let selectedFile = null;

      const { createFFmpeg, fetchFile } = FFmpeg;
      const ffmpeg = createFFmpeg({ log: true });

      videoFile.addEventListener('change', (e) => {
        selectedFile = e.target.files[0];
        compressBtn.disabled = !selectedFile;
      });

      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault(); e.stopPropagation();
        dropZone.style.background = '#e0f7fa';
      });
      dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault(); e.stopPropagation();
        dropZone.style.background = 'transparent';
      });
      dropZone.addEventListener('drop', (e) => {
        e.preventDefault(); e.stopPropagation();
        dropZone.style.background = 'transparent';
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith('video/')) {
          selectedFile = file;
          videoFile.files = e.dataTransfer.files;
          compressBtn.disabled = false;
        } else {
          alert('Please drop a valid video file.');
        }
      });

      compressBtn.addEventListener('click', async () => {
        if (!selectedFile) return alert('Please select a video file first.');

        compressBtn.disabled = spinner.style.display = 'block';

        try {
          if (!ffmpeg.isLoaded()) {
            ffmpeg.setProgress(({ ratio }) => {
              const p = Math.round(ratio * 100);
              document.getElementById('progressBar').value = p;
              document.getElementById('progressText').textContent = `${p}%`;
            });
            await ffmpeg.load();
          }

          // Write, exec, read, and display results
          const inName = selectedFile.name;
          const outName = 'compressed_' + Date.now() + '.mp4';
          const crf = document.getElementById('quality').value;
          const preset = document.getElementById('preset').value;
          const res = document.getElementById('resolution').value;

          let args = ['-i', inName, '-c:v', 'libx264', '-preset', preset, '-crf', crf, '-c:a', 'aac', '-b:a', '128k', '-movflags', '+faststart'];
          if (res !== 'original') args.push('-vf', `scale=-2:${res}`);
          args.push(outName);

          await ffmpeg.writeFile(inName, await fetchFile(selectedFile));
          await ffmpeg.exec(args);
          const data = await ffmpeg.readFile(outName);
          const blob = new Blob([data.buffer], { type: 'video/mp4' });
          const url = URL.createObjectURL(blob);

          // Display info and preview
          document.getElementById('originalSize').textContent = `Original: ${(selectedFile.size / 1048576).toFixed(2)} MB`;
          document.getElementById('compressedSize').textContent = `Compressed: ${(blob.size / 1048576).toFixed(2)} MB`;
          document.getElementById('compressionRatio').textContent = `Reduced by: ${((selectedFile.size - blob.size) / selectedFile.size * 100).toFixed(2)}%`;

          const dl = document.getElementById('downloadLink');
          dl.href = url;
          dl.download = outName;

          const v = document.getElementById('previewVideo');
          v.src = url;
          v.style.display = 'block';
          document.getElementById('outputContainer').style.display = 'block';

          await ffmpeg.deleteFile(inName);
          await ffmpeg.deleteFile(outName);
        } catch (err) {
          alert(`Compression error: ${err.message}`);
        } finally {
          spinner.style.display = 'none';
          compressBtn.disabled = false;
        }
      });
    });
  </script>
</body>
</html>
